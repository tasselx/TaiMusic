# TaiMusic å•é¦–æ­Œæ›²æ’­æ”¾æ¨¡å¼ä¼˜åŒ–æ€»ç»“

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

ä¼˜åŒ–å½“æ’­æ”¾åˆ—è¡¨åªæœ‰ä¸€é¦–æ­Œæ—¶çš„æ’­æ”¾æ¨¡å¼è¡Œä¸ºï¼Œç¡®ä¿å„ç§æ’­æ”¾æ¨¡å¼ï¼ˆé¡ºåºæ’­æ”¾ã€åˆ—è¡¨å¾ªç¯ã€å•æ›²å¾ªç¯ã€éšæœºæ’­æ”¾ï¼‰éƒ½èƒ½æ­£å¸¸æ‰§è¡Œï¼Œæä¾›ä¸€è‡´ä¸”ç¬¦åˆç”¨æˆ·æœŸæœ›çš„æ’­æ”¾ä½“éªŒã€‚

## âœ… å·²å®Œæˆçš„ä¼˜åŒ–

### 1. **å¢å¼º previous() æ–¹æ³•** (`src/utils/audioPlayer.ts`)

#### ä¿®æ”¹å†…å®¹ï¼š
- **é˜Ÿåˆ—ç©ºæ£€æŸ¥**: æ·»åŠ é˜Ÿåˆ—ä¸ºç©ºæ—¶çš„ä¿æŠ¤é€»è¾‘
- **å•é¦–æ­Œå¤„ç†**: å½“åªæœ‰ä¸€é¦–æ­Œæ—¶ï¼Œæ ¹æ®æ’­æ”¾æ¨¡å¼æä¾›åˆé€‚çš„è¡Œä¸º
- **æ¨¡å¼é€‚é…**: æ‰€æœ‰æ’­æ”¾æ¨¡å¼ä¸‹éƒ½èƒ½æ­£å¸¸å“åº”"ä¸Šä¸€é¦–"æ“ä½œ

#### ä¿®æ”¹å‰åå¯¹æ¯”ï¼š
```typescript
// ä¿®æ”¹å‰
async previous(): Promise<void> {
  let nextIndex = this.currentIndex - 1;
  
  if (nextIndex < 0) {
    if (this.playMode === PlayMode.LOOP) {
      nextIndex = this.queue.length - 1;
    } else {
      return; // å·²ç»æ˜¯ç¬¬ä¸€é¦–
    }
  }

  this.currentIndex = nextIndex;
  await this.play();
}

// ä¿®æ”¹å
async previous(): Promise<void> {
  // å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œç›´æ¥è¿”å›
  if (this.queue.length === 0) return;
  
  // å¦‚æœåªæœ‰ä¸€é¦–æ­Œï¼Œæ ¹æ®æ’­æ”¾æ¨¡å¼å¤„ç†
  if (this.queue.length === 1) {
    switch (this.playMode) {
      case PlayMode.SINGLE:
      case PlayMode.LOOP:
      case PlayMode.RANDOM:
        // é‡æ–°æ’­æ”¾å½“å‰æ­Œæ›²
        await this.play();
        return;
      case PlayMode.SEQUENCE:
        // é¡ºåºæ’­æ”¾æ¨¡å¼ä¸‹ï¼Œåªæœ‰ä¸€é¦–æ­Œæ—¶é‡æ–°æ’­æ”¾
        await this.play();
        return;
    }
  }
  
  let nextIndex = this.currentIndex - 1;
  
  if (nextIndex < 0) {
    if (this.playMode === PlayMode.LOOP) {
      nextIndex = this.queue.length - 1;
    } else {
      return; // å·²ç»æ˜¯ç¬¬ä¸€é¦–
    }
  }

  this.currentIndex = nextIndex;
  await this.play();
}
```

### 2. **å¢å¼º next() æ–¹æ³•** (`src/utils/audioPlayer.ts`)

#### ä¿®æ”¹å†…å®¹ï¼š
- **é˜Ÿåˆ—ç©ºæ£€æŸ¥**: æ·»åŠ é˜Ÿåˆ—ä¸ºç©ºæ—¶çš„ä¿æŠ¤é€»è¾‘
- **å•é¦–æ­Œå¤„ç†**: å½“åªæœ‰ä¸€é¦–æ­Œæ—¶ï¼Œæ‰€æœ‰æ¨¡å¼éƒ½é‡æ–°æ’­æ”¾å½“å‰æ­Œæ›²
- **ç”¨æˆ·ä½“éªŒ**: æ‰‹åŠ¨ç‚¹å‡»"ä¸‹ä¸€é¦–"æ—¶æä¾›å³æ—¶åé¦ˆ

#### ä¿®æ”¹å‰åå¯¹æ¯”ï¼š
```typescript
// ä¿®æ”¹å‰
async next(): Promise<void> {
  const nextIndex = this.getNextIndex();
  if (nextIndex !== -1) {
    this.currentIndex = nextIndex;
    await this.play();
  }
}

// ä¿®æ”¹å
async next(): Promise<void> {
  // å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œç›´æ¥è¿”å›
  if (this.queue.length === 0) return;
  
  // å¦‚æœåªæœ‰ä¸€é¦–æ­Œï¼Œæ ¹æ®æ’­æ”¾æ¨¡å¼å¤„ç†
  if (this.queue.length === 1) {
    switch (this.playMode) {
      case PlayMode.SINGLE:
      case PlayMode.LOOP:
      case PlayMode.RANDOM:
        // é‡æ–°æ’­æ”¾å½“å‰æ­Œæ›²
        await this.play();
        return;
      case PlayMode.SEQUENCE:
        // é¡ºåºæ’­æ”¾æ¨¡å¼ä¸‹ï¼Œæ‰‹åŠ¨ç‚¹å‡»ä¸‹ä¸€é¦–æ—¶é‡æ–°æ’­æ”¾
        await this.play();
        return;
    }
  }
  
  const nextIndex = this.getNextIndex();
  if (nextIndex !== -1) {
    this.currentIndex = nextIndex;
    await this.play();
  }
}
```

### 3. **ä¼˜åŒ– getNextIndex() æ–¹æ³•** (`src/utils/audioPlayer.ts`)

#### ä¿®æ”¹å†…å®¹ï¼š
- **é˜Ÿåˆ—ç©ºæ£€æŸ¥**: æ·»åŠ é˜Ÿåˆ—ä¸ºç©ºæ—¶çš„ä¿æŠ¤é€»è¾‘
- **é¡ºåºæ’­æ”¾ä¼˜åŒ–**: å½“åªæœ‰ä¸€é¦–æ­Œæ—¶ï¼Œè‡ªåŠ¨æ’­æ”¾ç»“æŸååœæ­¢ï¼ˆç¬¦åˆé¡ºåºæ’­æ”¾é€»è¾‘ï¼‰
- **æ³¨é‡Šå®Œå–„**: æ·»åŠ è¯¦ç»†çš„é€»è¾‘è¯´æ˜

#### ä¿®æ”¹å‰åå¯¹æ¯”ï¼š
```typescript
// ä¿®æ”¹å‰
private getNextIndex(): number {
  switch (this.playMode) {
    case PlayMode.SINGLE:
      return this.currentIndex; // å•æ›²å¾ªç¯
    
    case PlayMode.RANDOM:
      if (this.queue.length <= 1) return this.currentIndex;
      let randomIndex;
      do {
        randomIndex = Math.floor(Math.random() * this.queue.length);
      } while (randomIndex === this.currentIndex);
      return randomIndex;
    
    case PlayMode.SEQUENCE:
      return this.currentIndex + 1 < this.queue.length ? this.currentIndex + 1 : -1;
    
    case PlayMode.LOOP:
      return this.currentIndex + 1 < this.queue.length ? this.currentIndex + 1 : 0;
    
    default:
      return -1;
  }
}

// ä¿®æ”¹å
private getNextIndex(): number {
  // å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œè¿”å›-1
  if (this.queue.length === 0) return -1;
  
  switch (this.playMode) {
    case PlayMode.SINGLE:
      return this.currentIndex; // å•æ›²å¾ªç¯

    case PlayMode.RANDOM:
      if (this.queue.length <= 1) return this.currentIndex;
      let randomIndex;
      do {
        randomIndex = Math.floor(Math.random() * this.queue.length);
      } while (randomIndex === this.currentIndex);
      return randomIndex;

    case PlayMode.SEQUENCE:
      // é¡ºåºæ’­æ”¾ï¼šå¦‚æœåªæœ‰ä¸€é¦–æ­Œï¼Œåœæ­¢æ’­æ”¾ï¼›å¦åˆ™æ’­æ”¾ä¸‹ä¸€é¦–
      if (this.queue.length === 1) return -1; // åªæœ‰ä¸€é¦–æ­Œæ—¶åœæ­¢
      return this.currentIndex + 1 < this.queue.length ? this.currentIndex + 1 : -1;

    case PlayMode.LOOP:
      return this.currentIndex + 1 < this.queue.length ? this.currentIndex + 1 : 0;

    default:
      return -1;
  }
}
```

## ğŸ”§ æ’­æ”¾æ¨¡å¼è¡Œä¸ºè¯¦è§£

### 1. **å•æ›²å¾ªç¯ (SINGLE)**
- **åªæœ‰ä¸€é¦–æ­Œæ—¶**:
  - æ‰‹åŠ¨ç‚¹å‡»"ä¸Šä¸€é¦–"/"ä¸‹ä¸€é¦–": âœ… é‡æ–°æ’­æ”¾å½“å‰æ­Œæ›²
  - æ­Œæ›²æ’­æ”¾ç»“æŸ: âœ… è‡ªåŠ¨é‡æ–°æ’­æ”¾å½“å‰æ­Œæ›²
  - ç¬¦åˆå•æ›²å¾ªç¯çš„é¢„æœŸè¡Œä¸º

### 2. **åˆ—è¡¨å¾ªç¯ (LOOP)**
- **åªæœ‰ä¸€é¦–æ­Œæ—¶**:
  - æ‰‹åŠ¨ç‚¹å‡»"ä¸Šä¸€é¦–"/"ä¸‹ä¸€é¦–": âœ… é‡æ–°æ’­æ”¾å½“å‰æ­Œæ›²
  - æ­Œæ›²æ’­æ”¾ç»“æŸ: âœ… è‡ªåŠ¨é‡æ–°æ’­æ”¾å½“å‰æ­Œæ›²
  - è¡¨ç°ä¸å•æ›²å¾ªç¯ä¸€è‡´ï¼ˆå› ä¸ºåªæœ‰ä¸€é¦–æ­Œï¼‰

### 3. **éšæœºæ’­æ”¾ (RANDOM)**
- **åªæœ‰ä¸€é¦–æ­Œæ—¶**:
  - æ‰‹åŠ¨ç‚¹å‡»"ä¸Šä¸€é¦–"/"ä¸‹ä¸€é¦–": âœ… é‡æ–°æ’­æ”¾å½“å‰æ­Œæ›²
  - æ­Œæ›²æ’­æ”¾ç»“æŸ: âœ… è‡ªåŠ¨é‡æ–°æ’­æ”¾å½“å‰æ­Œæ›²
  - é¿å…äº†æ— é™å¾ªç¯çš„é—®é¢˜

### 4. **é¡ºåºæ’­æ”¾ (SEQUENCE)**
- **åªæœ‰ä¸€é¦–æ­Œæ—¶**:
  - æ‰‹åŠ¨ç‚¹å‡»"ä¸Šä¸€é¦–"/"ä¸‹ä¸€é¦–": âœ… é‡æ–°æ’­æ”¾å½“å‰æ­Œæ›²
  - æ­Œæ›²æ’­æ”¾ç»“æŸ: âœ… åœæ­¢æ’­æ”¾ï¼ˆç¬¦åˆé¡ºåºæ’­æ”¾é€»è¾‘ï¼‰
  - åŒºåˆ†æ‰‹åŠ¨æ“ä½œå’Œè‡ªåŠ¨æ’­æ”¾ç»“æŸçš„è¡Œä¸º

## ğŸ“Š ç”¨æˆ·ä½“éªŒæ”¹è¿›

### 1. **ä¸€è‡´æ€§**
- æ‰€æœ‰æ’­æ”¾æ¨¡å¼åœ¨åªæœ‰ä¸€é¦–æ­Œæ—¶éƒ½èƒ½æ­£å¸¸å·¥ä½œ
- ç”¨æˆ·æ“ä½œæœ‰æ˜ç¡®çš„åé¦ˆå’Œé¢„æœŸè¡Œä¸º
- é¿å…äº†æ“ä½œæ— å“åº”çš„æƒ…å†µ

### 2. **æ™ºèƒ½åŒ–**
- åŒºåˆ†æ‰‹åŠ¨æ“ä½œå’Œè‡ªåŠ¨æ’­æ”¾ç»“æŸçš„åœºæ™¯
- æ ¹æ®æ’­æ”¾æ¨¡å¼æä¾›ç¬¦åˆé€»è¾‘çš„è¡Œä¸º
- ä¿æŠ¤æ€§æ£€æŸ¥é¿å…å¼‚å¸¸æƒ…å†µ

### 3. **ç›´è§‚æ€§**
- æ‰‹åŠ¨ç‚¹å‡»æ§åˆ¶æŒ‰é’®æ€»æ˜¯æœ‰å“åº”
- æ’­æ”¾æ¨¡å¼çš„è¡Œä¸ºç¬¦åˆç”¨æˆ·ç›´è§‰
- å‡å°‘ç”¨æˆ·å›°æƒ‘å’Œæ“ä½œå¤±è¯¯

## ğŸ¯ è¦†ç›–çš„ä½¿ç”¨åœºæ™¯

### 1. **åŸºæœ¬æ“ä½œåœºæ™¯**
- âœ… åªæœ‰ä¸€é¦–æ­Œæ—¶ç‚¹å‡»"ä¸Šä¸€é¦–"æŒ‰é’®
- âœ… åªæœ‰ä¸€é¦–æ­Œæ—¶ç‚¹å‡»"ä¸‹ä¸€é¦–"æŒ‰é’®
- âœ… åªæœ‰ä¸€é¦–æ­Œæ—¶æ­Œæ›²æ’­æ”¾ç»“æŸ
- âœ… åˆ‡æ¢ä¸åŒæ’­æ”¾æ¨¡å¼

### 2. **è¾¹ç•Œæƒ…å†µ**
- âœ… ç©ºæ’­æ”¾åˆ—è¡¨çš„ä¿æŠ¤
- âœ… æ’­æ”¾æ¨¡å¼åˆ‡æ¢æ—¶çš„çŠ¶æ€ä¿æŒ
- âœ… æ’­æ”¾è¿‡ç¨‹ä¸­ä¿®æ”¹æ’­æ”¾åˆ—è¡¨

### 3. **ç”¨æˆ·äº¤äº’**
- âœ… å¿«é€Ÿè¿ç»­ç‚¹å‡»æ§åˆ¶æŒ‰é’®
- âœ… æ’­æ”¾è¿‡ç¨‹ä¸­åˆ‡æ¢æ’­æ”¾æ¨¡å¼
- âœ… æ·»åŠ /ç§»é™¤æ­Œæ›²æ—¶çš„çŠ¶æ€åŒæ­¥

## ğŸ” æµ‹è¯•å»ºè®®

å»ºè®®æµ‹è¯•ä»¥ä¸‹åœºæ™¯ç¡®ä¿åŠŸèƒ½æ­£å¸¸ï¼š

### 1. **åŸºæœ¬åŠŸèƒ½æµ‹è¯•**
- æ·»åŠ ä¸€é¦–æ­Œåˆ°æ’­æ”¾åˆ—è¡¨
- åœ¨ä¸åŒæ’­æ”¾æ¨¡å¼ä¸‹æµ‹è¯•"ä¸Šä¸€é¦–"å’Œ"ä¸‹ä¸€é¦–"æŒ‰é’®
- éªŒè¯æ­Œæ›²æ’­æ”¾ç»“æŸåçš„è¡Œä¸º

### 2. **æ’­æ”¾æ¨¡å¼åˆ‡æ¢æµ‹è¯•**
- æ’­æ”¾è¿‡ç¨‹ä¸­åˆ‡æ¢ä¸åŒæ’­æ”¾æ¨¡å¼
- éªŒè¯æ¯ç§æ¨¡å¼ä¸‹çš„è¡Œä¸ºæ˜¯å¦ç¬¦åˆé¢„æœŸ
- æµ‹è¯•æ¨¡å¼å›¾æ ‡å’Œæç¤ºæ˜¯å¦æ­£ç¡®

### 3. **è¾¹ç•Œæƒ…å†µæµ‹è¯•**
- ç©ºæ’­æ”¾åˆ—è¡¨æ—¶çš„æ“ä½œ
- å¿«é€Ÿè¿ç»­ç‚¹å‡»æ§åˆ¶æŒ‰é’®
- æ’­æ”¾è¿‡ç¨‹ä¸­æ¸…ç©ºæ’­æ”¾åˆ—è¡¨

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### 1. **æ–¹æ³•è°ƒç”¨å…³ç³»**
```
ç”¨æˆ·ç‚¹å‡»"ä¸‹ä¸€é¦–" â†’ next() â†’ getNextIndex() â†’ play()
æ­Œæ›²æ’­æ”¾ç»“æŸ â†’ handleSongEnd() â†’ getNextIndex() â†’ play()
ç”¨æˆ·ç‚¹å‡»"ä¸Šä¸€é¦–" â†’ previous() â†’ play()
```

### 2. **çŠ¶æ€ç®¡ç†**
- æ’­æ”¾æ¨¡å¼çŠ¶æ€é€šè¿‡ `playMode` å±æ€§ç®¡ç†
- é˜Ÿåˆ—çŠ¶æ€é€šè¿‡ `queue` æ•°ç»„ç®¡ç†
- å½“å‰ç´¢å¼•é€šè¿‡ `currentIndex` ç®¡ç†

### 3. **äº‹ä»¶é€šçŸ¥**
- æ’­æ”¾æ¨¡å¼å˜åŒ–é€šè¿‡ `onModeChange` äº‹ä»¶é€šçŸ¥
- æ­Œæ›²å˜åŒ–é€šè¿‡ `onSongChange` äº‹ä»¶é€šçŸ¥
- é˜Ÿåˆ—å˜åŒ–é€šè¿‡ `onQueueChange` äº‹ä»¶é€šçŸ¥

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

1. **ç”¨æˆ·æç¤º**: å¯ä»¥è€ƒè™‘åœ¨åªæœ‰ä¸€é¦–æ­Œæ—¶æ˜¾ç¤ºç‰¹æ®Šçš„æ’­æ”¾æ¨¡å¼æç¤º
2. **å¿«æ·æ“ä½œ**: æ·»åŠ é”®ç›˜å¿«æ·é”®æ”¯æŒæ’­æ”¾æ§åˆ¶
3. **æ’­æ”¾å†å²**: è®°å½•æ’­æ”¾æ¨¡å¼åˆ‡æ¢çš„å†å²
4. **ä¸ªæ€§åŒ–**: è®°ä½ç”¨æˆ·åå¥½çš„æ’­æ”¾æ¨¡å¼è®¾ç½®

---

**ä¿®æ”¹å®Œæˆæ—¶é—´**: 2024å¹´12æœˆ
**ä¿®æ”¹çŠ¶æ€**: âœ… å·²å®Œæˆ
**æµ‹è¯•çŠ¶æ€**: ğŸ”„ å¾…æµ‹è¯•
